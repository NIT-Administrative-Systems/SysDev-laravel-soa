<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>WebSSO | Northwestern Tools for Laravel</title>
    <meta name="generator" content="VuePress 1.8.1">
    
    <meta name="description" content="Enhance Laravel with easy access to popular Northwestern APIs & webSSO/Duo multi-factor authentication.">
    
    <link rel="preload" href="/SysDev-laravel-soa/assets/css/0.styles.9b2a9d77.css" as="style"><link rel="preload" href="/SysDev-laravel-soa/assets/js/app.2c9563ed.js" as="script"><link rel="preload" href="/SysDev-laravel-soa/assets/js/3.d1885edc.js" as="script"><link rel="preload" href="/SysDev-laravel-soa/assets/js/12.dd369eb0.js" as="script"><link rel="prefetch" href="/SysDev-laravel-soa/assets/js/10.91bba05f.js"><link rel="prefetch" href="/SysDev-laravel-soa/assets/js/11.6ed66ffc.js"><link rel="prefetch" href="/SysDev-laravel-soa/assets/js/4.fd1d8faa.js"><link rel="prefetch" href="/SysDev-laravel-soa/assets/js/5.8733efbf.js"><link rel="prefetch" href="/SysDev-laravel-soa/assets/js/6.ad9da22b.js"><link rel="prefetch" href="/SysDev-laravel-soa/assets/js/7.e990fce0.js"><link rel="prefetch" href="/SysDev-laravel-soa/assets/js/8.5dcbb3d2.js"><link rel="prefetch" href="/SysDev-laravel-soa/assets/js/9.192f2a37.js"><link rel="prefetch" href="/SysDev-laravel-soa/assets/js/vendors~docsearch.4a8594da.js">
    <link rel="stylesheet" href="/SysDev-laravel-soa/assets/css/0.styles.9b2a9d77.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/SysDev-laravel-soa/" class="home-link router-link-active"><!----> <span class="site-name">Northwestern Tools for Laravel</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"> <a href="https://github.com/NIT-Administrative-Systems/SysDev-laravel-soa" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/NIT-Administrative-Systems/SysDev-laravel-soa" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Getting Started</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/SysDev-laravel-soa/" aria-current="page" class="sidebar-link">Installation</a></li><li><a href="/SysDev-laravel-soa/upgrading.html" class="sidebar-link">Upgrading</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Services</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/SysDev-laravel-soa/websso.html" aria-current="page" class="active sidebar-link">WebSSO</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/SysDev-laravel-soa/websso.html#prerequisites" class="sidebar-link">Prerequisites</a></li><li class="sidebar-sub-header"><a href="/SysDev-laravel-soa/websso.html#setting-up-sso" class="sidebar-link">Setting up SSO</a></li><li class="sidebar-sub-header"><a href="/SysDev-laravel-soa/websso.html#changing-routes" class="sidebar-link">Changing Routes</a></li><li class="sidebar-sub-header"><a href="/SysDev-laravel-soa/websso.html#api" class="sidebar-link">API</a></li></ul></li><li><a href="/SysDev-laravel-soa/eventhub.html" class="sidebar-link">EventHub</a></li><li><a href="/SysDev-laravel-soa/directory-search.html" class="sidebar-link">Directory Search</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="websso"><a href="#websso" class="header-anchor">#</a> WebSSO</h1> <p>The package provides a command that will set up WebSSO, and optionally Duo multi-factor authentication (MFA).</p> <ul><li>Create SSO &amp; Duo controllers in <code>App\Http\Controllers\Auth</code></li> <li>Adds named routes to your <code>web/routes.php</code></li></ul> <p>The approach taken is flexible. It is suited for both applications that only use WebSSO <em>and</em> applications with multiple login methods.</p> <p>All of the above will still rely on the built-in Laravel <code>auth</code> middleware.</p> <div class="custom-block warning"><p class="custom-block-title">Notes for Advanced Users</p> <p>Authentication is achieved by logging users into Laravel; once the webSSO session is validated, your user's login session for your application is detached from the webSSO session.</p> <p>The package does not implement a custom <a href="https://laravel.com/docs/5.8/authentication#adding-custom-user-providers" target="_blank" rel="noopener noreferrer">auth provider<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> and relies on the default database provider for the <code>App\User</code> model.</p></div> <h2 id="prerequisites"><a href="#prerequisites" class="header-anchor">#</a> Prerequisites</h2> <p>You will need an Apigee key with access to the <code>IDM - Agentless WebSSO</code>. The key will include access to the SSO &amp; MFA API. This must be requested through the <a href="https://apiserviceregistry.northwestern.edu/" target="_blank" rel="noopener noreferrer">API service registry<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p>Your application must be served over HTTPS on a <code>northwestern.edu</code> domain. The SSO cookie (<code>nusso</code>) is flagged as Secure=true; there is no way for Laravel to access the cookie when served over an insecure http connection.</p> <h2 id="setting-up-sso"><a href="#setting-up-sso" class="header-anchor">#</a> Setting up SSO</h2> <p>Getting webSSO working should only take a few minutes.</p> <div class="language- extra-class"><pre class="language-text"><code>php artisan make:websso
</code></pre></div><p>First, add the following to your <code>.env</code>:</p> <div class="language-ini extra-class"><pre class="language-ini"><code><span class="token constant">WEBSSO_API_KEY</span><span class="token attr-value"><span class="token punctuation">=</span>YOUR_APIGEE_API_KEY</span>

<span class="token comment"># Prod would be https://prd-nusso.it.northwestern.edu</span>
<span class="token constant">WEBSSO_URL_BASE</span><span class="token attr-value"><span class="token punctuation">=</span>https://uat-nusso.it.northwestern.edu</span>

<span class="token comment"># Prod would be https://northwestern-prod.apigee.net/agentless-websso</span>
<span class="token constant">WEBSSO_API_URL_BASE</span><span class="token attr-value"><span class="token punctuation">=</span>https://northwestern-test.apigee.net/agentless-websso</span>

<span class="token comment"># Controls whether or not MFA will be required</span>
<span class="token comment"># You should enable MFA, unless there's a good reason not to!</span>
<span class="token constant">DUO_ENABLED</span><span class="token attr-value"><span class="token punctuation">=</span>true</span>
</code></pre></div><p>Review your <code>routes/web.php</code>. You can adjust the paths, if desired.</p> <p>Then, open up <code>App\Http\Controllers\Auth\WebSSOController</code> and implement the <code>findUserByNetID</code> method. You may inject any additional dependencies (e.g. <code>DirectorySearch</code>) you need in this method.</p> <p>It needs to return an object that implements the <code>Authenticatable</code> interface. The <code>App\User</code> model that Laravel comes with satisfies this requirement.</p> <p>If you return <code>null</code> from this method, the login will fail. This may be desired in cases where only certain pre-approved users are permitted to log in.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">use</span> <span class="token package">App<span class="token punctuation">\</span>User</span><span class="token punctuation">;</span>

<span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function">findUserByNetID</span><span class="token punctuation">(</span><span class="token class-name type-declaration">DirectorySearch</span> <span class="token variable">$directory_api</span><span class="token punctuation">,</span> <span class="token keyword type-hint">string</span> <span class="token variable">$netid</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token operator">?</span><span class="token class-name return-type">Authenticatable</span>
<span class="token punctuation">{</span>
    <span class="token comment">// If the user exists, they can log in.</span>
    <span class="token variable">$user</span> <span class="token operator">=</span> <span class="token class-name static-context">User</span><span class="token operator">::</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'netid'</span><span class="token punctuation">,</span> <span class="token variable">$netid</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$user</span> <span class="token operator">!==</span> <span class="token constant">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$user</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// If you have a Directory Search API key, you could grab info about them &amp; create a user.</span>
    <span class="token variable">$directory</span> <span class="token operator">=</span> <span class="token variable">$directory_api</span><span class="token operator">-&gt;</span><span class="token function">lookupNetId</span><span class="token punctuation">(</span><span class="token variable">$netid</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'basic'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$user</span> <span class="token operator">=</span> <span class="token class-name static-context">User</span><span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token string single-quoted-string">'name'</span> <span class="token operator">=&gt;</span> <span class="token variable">$netid</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'email'</span> <span class="token operator">=&gt;</span> <span class="token variable">$directory</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'mail'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token variable">$user</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>You may optionally implement the <code>authenticated</code> method. If you return a <code>redirect()</code>, it will be followed. Otherwise, the default Laravel behaviour will be used.</p> <h2 id="changing-routes"><a href="#changing-routes" class="header-anchor">#</a> Changing Routes</h2> <p>The default route names <code>login</code> &amp; <code>logout</code> are used by the controller traits.</p> <p>If you want to rename these routes, you will need to override these properties in both controllers.</p> <p>There is a fourth property, <code>logout_return_to_route</code>, that controls where the WebSSO logout page will send users. In an application that only uses WebSSO for logins, you can leave this <code>null</code>.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">class</span> WebSSOController <span class="token keyword">extends</span> <span class="token class-name">Controller</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">login_route_name</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'login'</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">logout_route_name</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'logout'</span><span class="token punctuation">;</span>

        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">logout_return_to_route</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// . . .</span>
<span class="token punctuation">}</span>
</code></pre></div><p>If you are only using WebSSO to authenticate in your app, this should not be necessary. If you have multiple login methods, you will either need to rename the routes, or update your <code>App\Http\Middleware\Authenticate</code> to send unauthenticated users to page that lets them choose their login method.</p> <h2 id="api"><a href="#api" class="header-anchor">#</a> API</h2> <p>The webSSO class will resolve the value of an <code>nusso</code> cookie into a NetID.</p> <div class="custom-block tip"><p class="custom-block-title">Unusual Use-cases Only</p> <p>If you have set up the authentication controllers as detailed in <a href="#authentication-flow">the previous section</a>, you should not need to use the <code>WebSSO</code> class yourself.</p></div> <div class="language-php extra-class"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Controllers</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">Northwestern<span class="token punctuation">\</span>SysDev<span class="token punctuation">\</span>SOA<span class="token punctuation">\</span>WebSSO</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">MyController</span> <span class="token keyword">extends</span> <span class="token class-name">Controllers</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Request</span> <span class="token variable">$request</span><span class="token punctuation">,</span> <span class="token class-name type-declaration">WebSSO</span> <span class="token variable">$sso</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// Note that $request-&gt;cookie() won't work here.</span>
        <span class="token comment">// It requires that all cookies be set by Laravel &amp; encrypted with the app's key.</span>
        <span class="token comment">//</span>
        <span class="token comment">// You can add cookie names to the EncryptCookies middleware's $except property to get around that,</span>
        <span class="token comment">// but for our example, $_COOKIE works just fine.</span>
        <span class="token variable">$token</span> <span class="token operator">=</span> <span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'nusso'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token variable">$user</span> <span class="token operator">=</span> <span class="token variable">$sso</span><span class="token operator">-&gt;</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token variable">$token</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$user</span> <span class="token operator">==</span> <span class="token constant">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'sso login page url here'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">dd</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token function">getNetid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// netID as a string with no frills</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/NIT-Administrative-Systems/SysDev-laravel-soa/edit/docs/websso.md" target="_blank" rel="noopener noreferrer">Edit Page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">4/23/2021, 2:58:38 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/SysDev-laravel-soa/upgrading.html" class="prev">
        Upgrading
      </a></span> <span class="next"><a href="/SysDev-laravel-soa/eventhub.html">
        EventHub
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/SysDev-laravel-soa/assets/js/app.2c9563ed.js" defer></script><script src="/SysDev-laravel-soa/assets/js/3.d1885edc.js" defer></script><script src="/SysDev-laravel-soa/assets/js/12.dd369eb0.js" defer></script>
  </body>
</html>
